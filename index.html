<!DOCTYPE html>
<html>
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-122946443-37"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-122946443-37");
    </script>
    <meta charset="utf-8">
    <title>CloudKit Catalog</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="css/ckcatalog.css" rel="stylesheet">
  </head>
  <body>
    <div class="main-pane" id="main">
      <div class="background-strip"></div>
      <div class="left-pane" id="left-pane">
        <div class="home">
          <div class="icon" id="home-icon"></div>
          <div class="toggle-buttons">
            <div class="expand-button left-pane-toggle-button" id="expand-left-column">&rang;</div>
            <div class="contract-button left-pane-toggle-button hide" id="contract-left-column">&lang;</div>
          </div>
          <div class="mask"></div>
        </div>
        <div class="left-bar-wrapper">
          <div class="vertical-scroll-container">
            <div class="menu-items">
              <div class="menu-item-container readme">
                <div class="border"></div>
                <a class="menu-item" href="#readme" title="README">
                  <div class="icon"></div>
                  <div class="name">README</div>
                </a>
              </div>
              <div class="menu-item-container authentication">
                <div class="border"></div>
                <a class="menu-item" href="#authentication" title="Authentication">
                  <div class="icon"></div>
                  <div class="name">Authentication</div>
                </a>
              </div>
              <div class="menu-item-container discoverability">
                <div class="border"></div>
                <a class="menu-item" href="#discoverability" title="Discoverability">
                  <div class="icon"></div>
                  <div class="name">Discoverability</div>
                </a>
              </div>
              <div class="menu-item-container query">
                <div class="border"></div>
                <a class="menu-item" href="#query" title="Query">
                  <div class="icon"></div>
                  <div class="name">Query</div>
                </a>
              </div>
              <div class="menu-item-container zones">
                <div class="border"></div>
                <a class="menu-item" href="#zones" title="Zones">
                  <div class="icon"></div>
                  <div class="name">Zones</div>
                </a>
              </div>
              <div class="menu-item-container records">
                <div class="border"></div>
                <a class="menu-item" href="#records" title="Records">
                  <div class="icon"></div>
                  <div class="name">Records</div>
                </a>
              </div>
              <div class="menu-item-container sync">
                <div class="border"></div>
                <a class="menu-item" href="#sync" title="Sync">
                  <div class="icon"></div>
                  <div class="name">Sync</div>
                </a>
              </div>
              <div class="menu-item-container sharing">
                <div class="border"></div>
                <a class="menu-item" href="#sharing" title="Sharing">
                  <div class="icon"></div>
                  <div class="name">Sharing</div>
                </a>
              </div>
              <div class="menu-item-container subscriptions">
                <div class="border"></div>
                <a class="menu-item" href="#subscriptions" title="Subscriptions">
                  <div class="icon"></div>
                  <div class="name">Subscriptions</div>
                </a>
              </div>
              <div class="menu-item-container notifications">
                <div class="border"></div>
                <a class="menu-item" href="#notifications" title="Notifications">
                  <div class="icon"></div>
                  <div class="name with-subtitle">Notifications</div>
                  <div class="subtitle" id="connected-text">Disconnected</div>
                  <div class="alert hide">
                    <div class="alert-text" id="number-of-alerts">0</div>
                  </div>
                </a>
              </div>
            </div>
          </div>
          <a class="menu-item documentation" href="https://developer.apple.com/documentation/cloudkitjs" target="_blank" title="Documentation">
            <div class="icon"></div>
            <div class="name">Documentation</div>
          </a>
        </div>
      </div>
      <div class="right-pane">
        <div class="header">
          <div class="left-button disabled">
            <div class="play-icon"></div>
            <button class="link" disabled="" id="run-button">Run Code</button>
          </div>
          <span id="username"></span>
        </div>
        <div class="alert-bar" id="config-bar">
          <span class="config-key">Container:</span>
          <span class="config-value" id="config-container"></span>
          <span class="config-key">Environment:</span>
          <span class="config-value" id="config-environment"></span>
        </div>
        <div class="vertical-scroll-container">
          <div class="page" id="page">
            <div class="page-segments"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="hide" id="dialog">
      <div id="dialog-text"></div>
    </div>
    <div class="hide">
      <div id="authentication">
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.setUpAuth()</h1>
          <p>This sample demonstrates how to authenticate a user with your app.
            There are two steps to authentication:</p>
          <ol>
            <li><b>Setting up auth.</b> This step checks whether a user is signed in. If you have specified
              <code>auth.persist = true</code> in your configuration you could run <i>setUpAuth</i> while bootstrapping
              your app and this function will use the stored cookie. The promise resolves with a <code>userIdentity</code> object or
              <code>null</code> and a sign-in or
              sign-out button will have been appended to the button container with id <code>apple-sign-in-button</code>
              or <code>apple-sign-out-button</code> (whichever is appropriate).
              These containers need to be in the DOM before executing the function and
              their IDs can be customised in <code>CloudKit.configure</code>.
            </li>
            <li><b>Binding handlers to the rendered button.</b> The promises <code>whenUserSignsIn</code> and <code>whenUserSignsOut</code>
              are resolved when the user signs-in/out respectively. The former resolves with a <code>userIdentity</code> object.</li>
          </ol>
          <p>If you selected the option <i>Request user discoverability at sign in</i> when creating your API token, a user will be able to grant
            discoverability permission to the app during the above sign-in flow.</p>
        </div>
      </div>
      <div id="discoverability">
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.fetchCurrentUserIdentity()</h1>
          <p>This sample demonstrates how to fetch the currently signed-in user&rsquo;s <code>userIdentity</code> object.
            If the current user has made himself discoverable to the app, this object will have nonempty <code>nameComponents</code>.
          </p>
        </div>
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.discoverAllUserIdentities()</h1>
          <p>This sample demonstrates how to obtain a list of <code>UserIdentity</code> objects corresponding to users of the app
            in the signed-in user&rsquo;s iCloud Contacts who have made themselves discoverable to the app.</p>
        </div>
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.discoverUserIdentityWithEmailAddress()</h1>
          <p>This sample demonstrates how to look up a user&rsquo;s discoverable information by email address. This method will
            always return a <code>userIdentity</code> object with the <code>lookupInfo</code> field populated. The other fields will be
            populated only if a matching discoverable user is found.</p>
        </div>
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.discoverUserIdentityWithUserRecordName()</h1>
          <p>This sample demonstrates how to look up a discoverable user&rsquo;s identity by user record name.
            The <code>.catch()</code> block is invoked when no matching user is found.</p>
        </div>
      </div>
      <div id="not-found">
        <div class="description">
          <h1>Page Not Found</h1>
          <p>The page you were looking for was not found. Please use the menu on the left to navigate the app.</p>
        </div>
      </div>
      <div id="notifications">
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.registerForNotifications()</h1>
          <p>This sample shows how to add a notification listener to the container. The listener will get called
            whenever the server sends us a notification of an update to a subscription. In order to receive notifications your app
            must park a connection with the notification backend using <code>registerForNotifications</code>.</p>
        </div>
      </div>
      <div id="records">
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.saveRecords()</h1>
          <p>This sample demonstrates how to save a record to a cloud database. Leave the recordName field blank
            to let the server generate a record name. Leave the recordChangeTag field blank when creating a new record and supply the latest
            server change tag when modifying an existing record. Create a share record in the private database by specifying the record type
            <code>cloudkit.share</code>.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.deleteRecords()</h1>
          <p>This sample demonstrates how an authenticated user can delete a record.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchRecords()</h1>
          <p>This sample demonstrates how to fetch a record by record name from any database and zone.</p>
        </div>
      </div>
      <div id="sharing">
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.fetchRecordInfos()</h1>
          <p>This sample demonstrates how to resolve a record from a stable short GUID.</p>
        </div>
        <div class="description">
          <h4>Class: Container</h4>
          <h1>.acceptShares()</h1>
          <p>This sample demonstrates how to accept a share with a short GUID.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.shareWithUI()</h1>
          <p>This sample shows how to share a record with the default sharing UI.</p>
        </div>
      </div>
      <div id="subscriptions">
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.saveSubscriptions()</h1>
          <p>This sample demonstrates how a user can subscribe to a change to a record in a specific zone
            (<i>zone subscription</i>) as well as to changes to records that match a query condition
            (<i>query subscription</i>). Once subscribed, your app can register for <a href="#notifications">notifications</a>
            of changes.
          </p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.deleteSubscriptions()</h1>
          <p>This sample shows how to delete a subscription by ID.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchSubscriptions()</h1>
          <p>This sample shows how to fetch a subscription by ID.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchAllSubscriptions()</h1>
          <p>This sample shows how to fetch all subscriptions.</p>
        </div>
      </div>
      <div id="sync">
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchDatabaseChanges()</h1>
          <p>This sample demonstrates how an authenticated user can get all changed zones relative to a meta-sync token in their
            private or shared database.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchRecordZoneChanges()</h1>
          <p>This sample demonstrates how an authenticated user can get all changes relative to a sync token in a custom or shared zone.
            If no sync token is provided all records in the zone are returned. The response will always contain a new sync token
            which can be cached in the client and sent in a new sync request. The sync token can also be used for paginating a result
            set. The <code>moreComing</code> boolean on the response indicates if the result set is incomplete.</p>
          <p>When you have a zone-level <a href="#subscriptions">subscription</a> you can get
            <a href="#notifications">notified</a> of changes to that zone and you would typically run <code>fetchRecordZoneChanges</code>
            to then fetch the latest changes and bring your client up-to-date.
          </p>
        </div>
      </div>
      <div id="zones">
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.saveRecordZones()</h1>
          <p>This sample shows how to create a custom zone in the user&rsquo;s private database. Zones are useful for
            syncing a user&rsquo;s data. Once you have created a custom zone you will be able to
            <a href="#records">create records</a> in that zone and test the <a href="#sync">sync</a> feature.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.deleteRecordZones()</h1>
          <p>This sample shows how to delete a custom zone by name from the private database.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchRecordZones()</h1>
          <p>This sample shows how to fetch a record zone by name from the private database.</p>
        </div>
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.fetchAllRecordZones()</h1>
          <p>This sample shows how to list all record zones in your private database. The response will always contain the default zone.</p>
        </div>
      </div>
      <div id="query">
        <div class="description">
          <h4>Class: Database</h4>
          <h1>.performQuery()</h1>
          <p>This sample demonstrates how any user can query records in the public database and a logged in user can query records in their
            private database.</p>
        </div>
      </div>
      <div id="readme">
        <div class="description">
          <h1>CloudKit on the web</h1>
          <p>This web application provides executable sample code for the core API methods provided by the CloudKit JS
            JavaScript library. While these methods cover many typical use cases, there are more flexible versions
            available if needed which allow for batch requests and more configuration. The user is advised to refer to the
            <a href="https://developer.apple.com/documentation/cloudkitjs">CloudKit JS Reference</a>
            for more information.</p>
          <p>All code examples can be run by clicking the play button at the top of the page. The results will be displayed below
            the sample code block.</p>
          <h2>Obtaining the CloudKit JS library</h2>
          <p>CloudKit JS is hosted at
            <a href="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js">https://cdn.apple-cloudkit.com/ck/2/cloudkit.js</a>.
            Include the library on your web page using either of the two methods below. You will
            automatically get updates and bug fixes as they are released.</p>
          <h3>Option #1 - Load CloudKit JS synchronously</h3>
          <pre><code>&lt;script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"&gt;&lt;/script&gt;</code></pre>
          <h3>Option #2 - Load CloudKit JS asynchronously</h3>
          <pre><code>&lt;!-- Listen for the cloudkitloaded event on the window object. --&gt;
            &lt;script&gt;
            window.addEventListener("cloudkitloaded", function() {
            // Now the global namespace CloudKit is defined and you can proceed
            // to configure your application.
            });
            &lt;/script&gt;
            
            &lt;!-- Include the script with the &lsquo;async&rsquo; attribute. --&gt;
            &lt;script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js" async&gt;&lt;/script&gt;</code></pre>
          <h2>Configuring CloudKit JS</h2>
          <p>The first use of the CloudKit namespace in your javascript app should be configuration code.</p>
          <pre><code>CloudKit.configure({
            locale: "en-us",
            
            containers: [{
            
            // Change this to a container identifier you own.
            containerIdentifier: "iCloud.cloud.tavitian.commute",
            
            apiTokenAuth: {
            // And generate a web token through CloudKit Dashboard.
            apiToken: "&lt;insert your token here&gt;",
            
            persist: true, // Sets a cookie.
            
            signInButton: {
            id: "apple-sign-in-button",
            theme: "black" // Other options: "white", "white-with-outline".
            },
            
            signOutButton: {
            id: "apple-sign-out-button",
            theme: "black"
            } 
            },
            
            environment: "production"
            }]
          });</code></pre>
          <p>Change the container identifier to one that you own.
            For more information on how to create a container see <a href="https://developer.apple.com/library/etc/redirect/ios_cloudkit_dashboard_guide">CloudKit Quick Start</a>.
            You can can create a container and generate an API token through the
            <a href="https://icloud.developer.apple.com/dashboard/">CloudKit Dashboard</a>.
          </p>
          <h2>Browser support</h2>
          <p>CloudKit JS is supported on Safari, Firefox, Chrome, Internet Explorer and Microsoft Edge, including embedded web views.
            For security reasons, a mobile web view must launch the Apple sign-in page in a native browser in order
            to use iCloud authentication.</p>
          <br>
        </div>
        <div class="description">
          <h1>Server-side CloudKit with node.js</h1>
          <p>A powerful CloudKit feature is the ability to make API calls with a server script. This feature is enabled by creating a server-to-server key in the
            <em>API Access</em> section of <a href="https://icloud.developer.apple.com/dashboard/">CloudKit Dashboard</a>. Such a key allows
            a server script to authenticate with CloudKit and make API calls to the <b>public database</b> with the inherited privileges of the creator of the key.
            In this section we will explain this process for a node.js script using CloudKit JS.
          </p>
          <h2>Creating a server-to-server key</h2>
          <p>If you are on a Mac, you already have OpenSSL installed and you can generate a private key in Terminal with this command:</p>
          <pre><code class="bash">openssl ecparam -name prime256v1 -genkey -noout -out eckey.pem
          </code></pre>
          <p>This will create the file <code>eckey.pem</code> in your working directory. In <a href="https://icloud.developer.apple.com/dashboard/">CloudKit Dashboard</a> navigate
            to <em>API Access -&gt; Server-to-Server Keys -&gt; Add Server-to-Server Key</em> and paste the output of the following command into the <b>Public Key</b> text field of the new key.
          </p>
          <pre><code class="bash">openssl ec -in eckey.pem -pubout
          </code></pre>
          <p>Hit <em>Save</em> and the <b>Key ID</b> attribute will get populated. You will use this key ID in configuring your node script.
          </p>
          <h2>Installing dependencies</h2>
          <p>In order to use CloudKit JS server-side you will need a <em>fetch</em> implementation such as <b>node-fetch</b> which you can install from NPM. You must also download CloudKit JS itself from Apple&rsquo;s CDN.</p>
          <pre><code class="bash">npm install node-fetch
            curl https://cdn.apple-cloudkit.com/ck/2/cloudkit.js &gt; cloudkit.js
          </code></pre>
          <h2>Configuring CloudKit JS in a node script</h2>
          <p>Create a script file in your working directory and add the following configuration code.</p>
          <pre><code class="javascript">var fetch = require("node-fetch");
            var CloudKit = require("./cloudkit");
            
            CloudKit.configure({
            services: {
            fetch: fetch,
            logger: console
            },
            containers: [{
            
            // Change this to a container identifier that you own.
            containerIdentifier: "iCloud.cloud.tavitian.commute",
            
            environment: "production",
            
            serverToServerKeyAuth: {
            
            // This is the key ID you generated in CloudKit Dashboard.
            keyID: "&lt;insert key ID&gt;",
            
            // This should reference the private key file that you used to
            // generate the above key ID.
            privateKeyFile: __dirname + "/eckey.pem"
            
            }
            }]
            });
          </code></pre>
          <p><b>Note:</b> Never expose or share the above private key with anyone, including Apple, as it has unrestricted access to your CloudKit container.</p>
          <h2>Authenticating and using the APIs</h2>
          <p>Before making API calls your script needs to authenticate with CloudKit using the server-to-server key that was set in the
            configuration code.</p>
          <pre><code class="javascript">var container = CloudKit.getDefaultContainer();
            
            // Server to server keys only allow calls to the public database.
            var database = container.publicCloudDatabase;
            
            
            // Authenticate with CloudKit using the server-to-server
            // key set in CloudKit.configure()
            container.setUpAuth()
            .then(function(userInfo) {
            
            // The userInfo is that of the user who created the key in CloudKit Dashboard.
            // If this user has permission to write a record of type Item to the
            // public database, the following call will succeed.
            return database.saveRecords({ recordType: "Stations" });
            
            }).then(function(response) {
            
            var savedRecord = response.records[0];
            console.log("Record name:", savedRecord.recordName);
            
            process.exit(0);
            
            }).catch(function(error) {
            // Handle the error.
            process.exit(1);
            });
          </code></pre>
          <p>You are now ready to start scripting with CloudKit JS and node.js. You may wish to look at the sections <a href="#query">Query</a> and
            <a href="#records">Records</a> for examples of API calls that you can use in server-side scripts.</p>
          <br>
        </div>
      </div>
    </div>
    <script>
      if(typeof CKCatalog === "undefined") {
        CKCatalog = {};
      }
      
      if(typeof CKCatalog.tabs === "undefined") {
        CKCatalog.tabs = {
          "readme": [
            { title: "CloudKit on the web" },
            { title: "Server-side CloudKit with node.js" }
          ],
          "not-found": [{}]
        };
      }
      
      if(typeof CKCatalog.FormInputHelpers === "undefined") {
        CKCatalog.FormInputHelpers = {
          Filters: {}
        };
      }
    </script>
    <script src="js/ckcatalog.js"></script>
    <script async onload="CKCatalog.tabManager.initializeCodeHighlighting()" src="js/highlight.pack.js"></script>
    <script async src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
  </body>
</html>
